# -*- coding: utf-8 -*-
"""step4_threshold_and_evaluation.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1-u1bg9jusQwuw8VleKB2ECWuoVN8qaZh
"""

import torch
import torch.nn as nn
import pandas as pd
import numpy as np
from sklearn.preprocessing import StandardScaler

# -------------------------------------------------
# SAME MODEL (DO NOT CHANGE)
# -------------------------------------------------
class GlobalCNN_Autoencoder(nn.Module):
    def __init__(self, input_features):
        super().__init__()

        self.encoder = nn.Sequential(
            nn.Conv1d(1, 32, kernel_size=3, padding=1),
            nn.BatchNorm1d(32),
            nn.ReLU(),

            nn.Conv1d(32, 16, kernel_size=3, padding=1),
            nn.BatchNorm1d(16),
            nn.ReLU(),

            nn.MaxPool1d(2)
        )

        self.decoder = nn.Sequential(
            nn.Upsample(scale_factor=2),

            nn.Conv1d(16, 32, kernel_size=3, padding=1),
            nn.BatchNorm1d(32),
            nn.ReLU(),

            nn.Conv1d(32, 1, kernel_size=3, padding=1)
        )

    def forward(self, x):
        return self.decoder(self.encoder(x))


# -------------------------------------------------
# DATA LOADING
# -------------------------------------------------
def load_data(csv_path, max_samples=100000):
    df = pd.read_csv(csv_path, nrows=max_samples)

    df = df.select_dtypes(include=[np.number])
    df = df.replace([np.inf, -np.inf], np.nan)
    df = df.dropna()

    scaler = StandardScaler()
    X = scaler.fit_transform(df.values)

    return X


# -------------------------------------------------
# RECONSTRUCTION ERROR
# -------------------------------------------------
def reconstruction_error(model, data):
    model.eval()
    with torch.no_grad():
        x = torch.tensor(data, dtype=torch.float32).unsqueeze(1)
        recon = model(x)
        mse = torch.mean((x - recon) ** 2, dim=(1, 2))
    return mse.numpy()


# -------------------------------------------------
# MAIN
# -------------------------------------------------
if __name__ == "__main__":

    # ðŸ”´ UPDATE PATHS IF NEEDED
    BENIGN_CSV = "/content/Monday-WorkingHours.pcap_ISCX.csv"
    ATTACK_CSV = "/content/Tuesday-WorkingHours.pcap_ISCX.csv"

    # Load benign data
    benign_data = load_data(BENIGN_CSV)

    # Load model
    input_features = benign_data.shape[1]
    model = GlobalCNN_Autoencoder(input_features)
    model.load_state_dict(
        torch.load("/content/global_federated_model.pt", map_location="cpu")
    )

    print("ðŸ”¹ Computing reconstruction error on benign data")
    benign_errors = reconstruction_error(model, benign_data)

    # Threshold = 95th percentile
    threshold = np.percentile(benign_errors, 95)

    print(f"\nâœ… Anomaly Threshold (95th percentile): {threshold:.6f}")

    # ---------------- Evaluation on attacks ----------------
    print("\nðŸ”¹ Evaluating on attack data")
    attack_data = load_data(ATTACK_CSV)
    attack_errors = reconstruction_error(model, attack_data)

    print(f"Average benign error : {benign_errors.mean():.6f}")
    print(f"Average attack error : {attack_errors.mean():.6f}")

    detected = np.sum(attack_errors > threshold)
    print(f"Detected attacks: {detected}/{len(attack_errors)}")

    # Save threshold
    np.save("anomaly_threshold.npy", threshold)
    print("\nâœ… Threshold saved as anomaly_threshold.npy")